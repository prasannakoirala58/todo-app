<%- include('partials/header') %>

<main class="container mx-auto mt-10 px-6">
  <!-- Form to add a new todo -->
  <div class="bg-white shadow-md rounded-lg p-6 mb-10">
    <h2 class="text-2xl font-bold mb-4">Add a new Todo</h2>

    <form action="/add" method="POST">
      <div class="mb-4">
        <label for="name" class="block text-textPrimary text-left mb-2">Todo Name</label>
        <input
          type="text"
          id="name"
          name="name"
          class="border border-gray-300 p-2 rounded w-full"
          required
        />
      </div>
      <div class="mb-4">
        <label for="description" class="block text-textPrimary text-left mb-2"
          >Description</label
        >
        <textarea
          id="description"
          name="description"
          class="border border-gray-300 p-2 rounded w-full"
          required
        ></textarea>
      </div>
      <div class="text-left">
        <button
          type="submit"
          class="bg-[#173E66] hover:bg-[#162866] text-white py-2 px-4 rounded transition duration-200"
        >
          Add Todo
        </button>
      </div>
    </form>
  </div>

  <!-- Display Todos in a table -->
  <h2 class="text-2xl font-bold mb-4">Todos</h2>

  <table class="table-auto w-full text-left">
    <thead>
      <tr class="bg-secondary text-left text-primary">
        <th class="px-4 py-2">Name</th>
        <th class="px-4 py-2">Description</th>
        <th class="px-4 py-2">Date</th>
        <th class="px-4 py-2">Actions</th>
      </tr>
    </thead>
    <tbody id="todo-list">
      <% todos.forEach(todo => { %>
      <tr class="border-b border-gray-300 hover:bg-gray-100" id="todo-<%= todo._id %>">
        <td class="px-4 py-2" class="todo-name"><%= todo.name %></td>
        <td class="px-4 py-2" class="todo-description"><%= todo.description %></td>
        <td class="px-4 py-2"><%= todo.date.toDateString() %></td>
        <td class="px-4 py-2 flex space-x-6 text-lg">
          <!-- Mark as Done -->
          <form class="mark-as-done-form" data-id="<%= todo._id %>" method="POST">
            <button class="hover:text-green-700 transition duration-200">
              <i class="<%= todo.isDone ? 'fas fa-circle-check' : 'far fa-circle' %>"></i>
            </button>
          </form>

          <!-- Update (Edit) -->
          <button
            class="hover:text-yellow-600 transition duration-200 edit-todo"
            data-id="<%= todo._id %>"
            data-name="<%= todo.name %>"
            data-description="<%= todo.description %>"
          >
            <i class="fas fa-edit"></i>
          </button>

          <!-- Delete -->
          <form class="delete-todo-form" data-id="<%= todo._id %>" method="POST">
            <button class="hover:text-red-700 transition duration-200">
              <i class="fas fa-trash"></i>
            </button>
          </form>
        </td>
      </tr>
      <% }) %>
    </tbody>
  </table>
</main>

<!-- Modal for Editing Todo -->
<div
  id="editModal"
  class="hidden fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center"
>
  <div class="bg-white p-8 w-2/5 rounded-lg shadow-lg relative">
    <button
      id="closeModal"
      class="absolute top-4 right-4 text-2xl text-gray-500 hover:text-gray-700"
    >
      <i class="fas fa-times"></i>
    </button>
    <h2 class="text-2xl font-bold mb-4">Edit Todo</h2>
    <form id="editTodoForm" action="" method="POST">
      <div class="mb-4">
        <label for="editName" class="block mb-2">Todo Name</label>
        <input
          type="text"
          id="editName"
          name="name"
          class="border border-gray-300 p-2 rounded w-full"
          required
        />
      </div>
      <div class="mb-4">
        <label for="editDescription" class="block mb-2">Description</label>
        <textarea
          id="editDescription"
          name="description"
          class="border border-gray-300 p-2 rounded w-full"
          required
        ></textarea>
      </div>
      <button type="submit" class="bg-primary text-white py-2 px-4 rounded">
        Save Changes
      </button>
    </form>
  </div>
</div>

<script>
  // Handle delete
  document.querySelectorAll('.delete-todo-form').forEach((form) => {
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      const todoId = this.dataset.id;

      fetch(`/delete/${todoId}?_method=DELETE`, {
        method: 'POST',
      })
        .then((response) => response.json())
        .then(() => {
          document.getElementById(`todo-${todoId}`).remove();
        })
        .catch((error) => console.error('Error:', error));
    });
  });

  // Handle mark as done
  document.querySelectorAll('.mark-as-done-form').forEach((form) => {
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      const todoId = this.dataset.id;

      fetch(`/done/${todoId}?_method=PUT`, {
        method: 'POST',
      })
        .then((response) => response.json())
        .then((data) => {
          const icon = this.querySelector('i');
          if (data.isDone) {
            icon.classList.remove('far', 'fa-circle');
            icon.classList.add('fas', 'fa-circle-check');
            icon.classList.add('text-green-600');
          } else {
            icon.classList.remove('fas', 'fa-circle-check');
            icon.classList.add('far', 'fa-circle');
            icon.classList.remove('text-green-600');
          }
        })
        .catch((error) => console.error('Error:', error));
    });
  });

  // Handle edit modal
  document.querySelectorAll('.edit-todo').forEach((button) => {
    button.addEventListener('click', function () {
      const todoId = this.dataset.id;
      const todoName = this.dataset.name;
      const todoDescription = this.dataset.description;

      // Show the modal
      const modal = document.getElementById('editModal');
      modal.classList.remove('hidden');

      // Pre-fill the modal form
      document.getElementById('editName').value = todoName;
      document.getElementById('editDescription').value = todoDescription;
      document.getElementById('editTodoForm').action = `/update/${todoId}?_method=PUT`;
    });
  });

  // Handle close modal
  document.getElementById('closeModal').addEventListener('click', function () {
    const modal = document.getElementById('editModal');
    modal.classList.add('hidden');
  });

  // Handle update submission via AJAX
  document.getElementById('editTodoForm').addEventListener('submit', function (e) {
    e.preventDefault();

    const form = this;
    const todoId = form.action.split('/').pop(); // Extract the todo ID from the form action
    const formData = new FormData(form);

    fetch(`/update/${todoId}`, {
      method: 'POST',
      body: formData,
    })
      .then((response) => response.ok)
      .then(() => {
        const todoRow = document.getElementById(`todo-${todoId}`);
        todoRow.querySelector('.todo-name').textContent = formData.get('name');
        todoRow.querySelector('.todo-description').textContent = formData.get('description');

        // Hide the modal after update
        document.getElementById('editModal').classList.add('hidden');
      })
      .catch((error) => console.error('Error:', error));
  });
</script>

<%- include('partials/footer') %>
